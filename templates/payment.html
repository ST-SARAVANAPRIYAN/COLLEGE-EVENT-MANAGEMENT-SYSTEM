<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - {{ event.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .payment-container {
            max-width: 800px;
            margin: 50px auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .payment-header {
            background: linear-gradient(135deg, #1a9be0, #05c27b);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .payment-body {
            padding: 30px;
        }
        
        .payment-details {
            margin-bottom: 30px;
        }
        
        .price-tag {
            font-size: 32px;
            font-weight: bold;
            color: #1a9be0;
        }
        
        .upi-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .payment-option {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option:hover {
            background-color: #e9ecef;
        }
        
        .payment-option.active {
            border-color: #1a9be0;
            background-color: rgba(26, 155, 224, 0.05);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a9be0, #05c27b);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #178cc8, #04a66a);
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            background-color: white;
        }
        
        .upi-details {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #dee2e6;
            border-radius: 5px;
            background-color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="payment-container">
            <div class="payment-header">
                <h2>Complete Your Payment</h2>
                <p>{{ event.name }}</p>
            </div>
            
            <div class="payment-body">
                <div class="payment-details">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>Event Details</h5>
                            <p><strong>Name:</strong> {{ event.name }}</p>
                            <p><strong>Date:</strong> {% if event.start_date %}{{ event.start_date.strftime('%Y-%m-%d') }}{% else %}{{ event.date }}{% endif %}</p>
                            <p><strong>Time:</strong> {{ event.start_time or 'TBA' }}</p>
                            <p><strong>Venue:</strong> {{ event.venue or 'TBA' }}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <p>Amount</p>
                            <div class="price-tag">₹{{ event.price }}</div>
                        </div>
                    </div>
                </div>
                  <div class="payment-options">
                    {% if upi_id %}
                    <div class="payment-option active" id="upiOption">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5><i class="fas fa-mobile-alt text-primary me-2"></i> UPI Payment</h5>
                                <p class="text-muted">Pay using any UPI app like Google Pay, PhonePe, BHIM, Paytm</p>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="upiRadio" checked>
                                <label class="form-check-label" for="upiRadio"></label>
                            </div>
                        </div>
                        
                        <div class="upi-section mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="qr-container">
                                        <p>Scan QR to pay</p>
                                        <!-- Base64 UPI QR code for demo, in production generate dynamically -->
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?data=upi%3A%2F%2Fpay%3Fpa%3D{{ upi_id }}%26pn%3D{{ organiser.name|urlencode }}%26tr%3DEVENT{{ event.id }}REG{{ registration.id }}%26am%3D{{ event.price }}%26cu%3DINR&size=200x200" alt="UPI QR Code" class="qr-code">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="upi-details">
                                        <h6>UPI Payment Details</h6>
                                        <p><strong>Payee:</strong> {{ organiser.name }}</p>
                                        <p><strong>UPI ID:</strong> {{ upi_id }}</p>
                                        <p><strong>Amount:</strong> ₹{{ event.price }}</p>
                                        <p><strong>Reference:</strong> EVENT{{ event.id }}REG{{ registration.id }}</p>
                                        <small class="text-muted">After payment, the system will automatically verify and record your transaction.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                          <!-- Transaction verification status -->
                        <div class="mt-3 transaction-verification-section">                            
                            <div class="alert alert-info" id="transaction-status">
                                <i class="fas fa-info-circle me-2"></i> After making your UPI payment, submit your transaction ID below for the organizer to verify your payment.
                            </div>
                            
                            {% if registration.payment_status == 'pending' %}
                            <!-- Transaction ID submission form -->
                            <div class="transaction-submission mt-3 p-3 border rounded bg-light">
                                <h6 class="mb-3"><i class="fas fa-receipt me-2"></i> Submit Transaction ID</h6>
                                <form id="transaction-form" action="{{ url_for('payment.submit_transaction_id', registration_id=registration.id) }}" method="POST">
                                    <div class="mb-3">
                                        <label for="transaction_id" class="form-label">UPI Transaction ID*</label>
                                        <input type="text" class="form-control" id="transaction_id" name="transaction_id" placeholder="Enter the transaction ID from your UPI app" required>
                                        <div class="form-text">This can be found in your UPI app's payment history or transaction receipt</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="transaction_screenshot" class="form-label">Screenshot (Optional)</label>
                                        <input type="file" class="form-control" id="transaction_screenshot" name="transaction_screenshot">
                                        <div class="form-text">Upload a screenshot of your payment receipt for faster verification</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="transaction_notes" class="form-label">Notes (Optional)</label>
                                        <textarea class="form-control" id="transaction_notes" name="transaction_notes" rows="2" placeholder="Any additional information..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-paper-plane me-2"></i> Submit for Verification
                                    </button>
                                </form>
                            </div>
                            {% elif registration.payment_status == 'verification_pending' %}
                            <!-- Pending verification message -->
                            <div class="transaction-details mt-3 p-3 border rounded bg-light">
                                <h6 class="mb-3"><i class="fas fa-clock text-warning me-2"></i> Verification Pending</h6>
                                <div class="transaction-info">
                                    <p class="mb-2"><strong>Transaction ID:</strong> {{ registration.payment_id }}</p>
                                    <p class="mb-2"><strong>Submitted:</strong> {{ registration.registration_date.strftime('%Y-%m-%d %H:%M') }}</p>
                                    <p class="mb-2"><strong>Status:</strong> <span class="badge bg-warning">Verification Pending</span></p>
                                </div>
                                <div class="alert alert-info mt-3 mb-0">
                                    <small><i class="fas fa-info-circle me-2"></i> Your payment is being verified by the organizer. You will receive an email notification once the verification is complete.</small>
                                </div>
                            </div>
                            {% elif registration.payment_status == 'completed' %}
                            <!-- Verified payment message -->
                            <div class="transaction-details mt-3 p-3 border rounded bg-light">
                                <h6 class="mb-3"><i class="fas fa-check-circle text-success me-2"></i> Payment Verified</h6>
                                <div class="transaction-info">
                                    <p class="mb-2"><strong>Transaction ID:</strong> {{ registration.payment_id }}</p>
                                    <p class="mb-2"><strong>Verified Date:</strong> {{ registration.verification_date.strftime('%Y-%m-%d %H:%M') if registration.verification_date else 'N/A' }}</p>
                                    <p class="mb-2"><strong>Status:</strong> <span class="badge bg-success">Verified</span></p>
                                    {% if registration.verification_notes %}
                                    <p class="mb-2"><strong>Notes:</strong> {{ registration.verification_notes }}</p>
                                    {% endif %}
                                </div>
                                
                                <a href="{{ url_for('event.download_ticket', registration_id=registration.id) }}" class="btn btn-success w-100 mt-3">
                                    <i class="fas fa-ticket-alt me-2"></i> Download Ticket
                                </a>
                            </div>
                            {% elif registration.payment_status == 'rejected' %}
                            <!-- Rejected payment message -->
                            <div class="transaction-details mt-3 p-3 border rounded bg-light">
                                <h6 class="mb-3"><i class="fas fa-times-circle text-danger me-2"></i> Payment Rejected</h6>
                                <div class="transaction-info">
                                    <p class="mb-2"><strong>Transaction ID:</strong> {{ registration.payment_id }}</p>
                                    <p class="mb-2"><strong>Verification Date:</strong> {{ registration.verification_date.strftime('%Y-%m-%d %H:%M') if registration.verification_date else 'N/A' }}</p>
                                    <p class="mb-2"><strong>Status:</strong> <span class="badge bg-danger">Rejected</span></p>
                                    {% if registration.verification_notes %}
                                    <p class="mb-2"><strong>Reason:</strong> {{ registration.verification_notes }}</p>
                                    {% endif %}
                                </div>
                                <div class="alert alert-danger mt-3 mb-0">
                                    <small><i class="fas fa-exclamation-triangle me-2"></i> Your payment verification was rejected. Please contact the organizer or submit a new transaction ID.</small>
                                </div>
                                <button class="btn btn-primary w-100 mt-3" id="retry-button" onclick="resetPaymentForm()">
                                    <i class="fas fa-redo me-2"></i> Try Again
                                </button>
                            </div>
                            {% endif %}
                            
                            {% if registration.payment_status == 'completed' %}
                            <a href="{{ url_for('participant.dashboard') }}" class="btn btn-primary w-100 mt-3">
                                <i class="fas fa-home me-2"></i> Go to Dashboard
                            </a>
                            {% endif %}
                        </div>
                    </div>                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> UPI payment option is not available for this event. The organizer hasn't configured a UPI ID yet. Please use the card payment option below.
                        {% if session.get('user_id') == event.created_by or session.get('user_id') == event.organiser_id %}
                        <div class="mt-2">
                            <a href="{{ url_for('payment.setup_upi', event_id=event.id) }}" class="alert-link">
                                <i class="fas fa-cog me-1"></i> I'm the organizer. Set up UPI payments now
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="payment-option {% if not upi_id %}active{% endif %}" id="cardOption">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5><i class="fas fa-credit-card text-primary me-2"></i> Card/Net Banking/Wallet</h5>
                                <p class="text-muted">Pay using Credit/Debit card, Net Banking or wallets</p>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cardRadio" {% if not upi_id %}checked{% endif %}>
                                <label class="form-check-label" for="cardRadio"></label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100 mt-3" id="razorpay-button">
                            <i class="fas fa-credit-card me-2"></i> Pay ₹{{ event.price }} securely
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 text-center">
                    <a href="{{ url_for('event.event_detail', event_id=event.id) }}" class="text-decoration-none">
                        <i class="fas fa-arrow-left me-2"></i> Return to event
                    </a>
                </div>
            </div>
        </div>
    </div>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle between payment options
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('active');
                    opt.querySelector('input[type="radio"]').checked = false;
                });
                this.classList.add('active');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Automatic UPI payment verification
        let pollInterval;
        let transactionVerified = false;
          function startTransactionPolling() {
            pollInterval = setInterval(checkTransactionStatus, 10000); // Check every 10 seconds
            // Auto-stop polling after 5 minutes (300000ms)
            setTimeout(() => {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    document.getElementById('transaction-status').innerHTML = 
                        `<i class="fas fa-info-circle me-2"></i> 
                         If you've completed the payment, please wait for the organizer to verify it. You will receive an email confirmation.`;
                }
            }, 300000);
        }
        
        function checkTransactionStatus() {
            fetch("/api/payments/check_upi_status/{{ registration.id }}")
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        transactionVerified = true;
                        clearInterval(pollInterval);
                        
                        // Update UI to show transaction details
                        document.getElementById('transaction-status').innerHTML = 
                            `<i class="fas fa-check-circle me-2"></i> 
                             Payment received successfully! Thank you.`;
                        document.getElementById('transaction-status').classList.remove('alert-info');
                        document.getElementById('transaction-status').classList.add('alert-success');
                        
                        // Show transaction details
                        document.getElementById('transaction-id').textContent = data.transaction_id;
                        document.getElementById('transaction-time').textContent = data.timestamp;
                        document.getElementById('transaction-details').style.display = 'block';
                        
                        // Show continue button
                        document.getElementById('continue-button').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error checking transaction status:', error);
                });
        }
        
        // Manual verification button
        document.getElementById('manual-verify-btn').addEventListener('click', function() {
            document.getElementById('transaction-status').innerHTML = 
                `<i class="fas fa-spinner fa-spin me-2"></i> 
                 Verifying your payment...`;
            
            checkTransactionStatus();
        });
        
        // Continue button
        document.getElementById('continue-button').addEventListener('click', function() {
            window.location.href = "{{ url_for('payment.payment_success', registration_id=registration.id, payment_method='upi') }}";
        });
        
        // Start polling when page loads
        document.addEventListener('DOMContentLoaded', function() {
            startTransactionPolling();
        });
        
        // Legacy function (now hidden, maintained for compatibility)
        function completeUpiPayment() {
            if (confirm("Have you completed the payment using UPI?")) {
                window.location.href = "{{ url_for('payment.payment_success', registration_id=registration.id, payment_method='upi') }}";
            }
        }
        
        // Razorpay integration
        document.getElementById('razorpay-button').addEventListener('click', function() {
            var options = {
                key: "{{ razorpay_key_id }}",
                amount: "{{ amount }}",
                currency: "{{ currency }}",
                name: "College Event Management System",
                description: "{{ event.name }}",
                order_id: "{{ order_id }}",
                handler: function(response) {
                    // Send the payment ID to server for verification
                    fetch('/api/payments/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            payment_id: response.razorpay_payment_id,
                            registration_id: "{{ registration.id }}",
                            order_id: response.razorpay_order_id,
                            signature: response.razorpay_signature
                        })
                    })
                    .then(response => response.json())                    .then(data => {
                        if (data.success) {
                            window.location.href = "{{ url_for('payment.payment_success', registration_id=registration.id, payment_method='razorpay') }}";
                        } else {
                            alert("Payment verification failed: " + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("An error occurred during payment verification");
                    });
                },
                prefill: {
                    name: "{{ user_name }}",
                    email: "{{ user_email }}",
                    contact: "{{ user_phone }}"
                },
                notes: {
                    event_name: "{{ event.name }}",
                    registration_id: "{{ registration.id }}"
                },
                theme: {
                    color: "#1a9be0"
                }
            };
            
            var rzp = new Razorpay(options);
            rzp.open();
        });
    </script>
</body>
</html>
