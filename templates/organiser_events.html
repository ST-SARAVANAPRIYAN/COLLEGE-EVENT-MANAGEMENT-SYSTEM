{% extends 'organiser_base.html' %}

{% block title %}CEMS - Manage Events{% endblock %}

{% block page_title %}Manage Events{% endblock %}

{% block extra_styles %}
.event-filters {
    margin-bottom: 20px;
    padding: 15px;
    border-radius: 10px;
    background-color: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.event-card {
    border-radius: 10px;
    margin-bottom: 20px;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    background-color: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.event-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.event-card .card-header {
    padding: 15px;
    background-color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.event-card .card-body {
    padding: 15px;
}

.event-actions {
    display: flex;
    gap: 5px;
}

.action-btn {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background-color: #f8f9fa;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.2s;
}

.action-btn:hover {
    transform: scale(1.1);
}

.action-btn.edit:hover {
    background-color: #3e64ff;
    color: white;
}

.action-btn.delete:hover {
    background-color: #f5365c;
    color: white;
}

.action-btn.view:hover {
    background-color: #2dce89;
    color: white;
}

.action-btn.upload:hover {
    background-color: #fb6340;
    color: white;
}

.action-btn.add-sub-event:hover {
    background-color: #6c757d;
    color: white;
}

.custom-tab {
    cursor: pointer;
    padding: 8px 16px;
    border-radius: 5px 5px 0 0;
    transition: all 0.2s;
}

.custom-tab.active {
    background-color: white;
    border: 1px solid #dee2e6;
    border-bottom-color: white;
    margin-bottom: -1px;
}

.custom-tabs {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 15px;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.search-container {
    position: relative;
    margin-bottom: 15px;
}

.search-container input {
    padding-left: 35px;
}

.search-icon {
    position: absolute;
    left: 10px;
    top: 10px;
    color: #6c757d;
}

#events-container {
    min-height: 200px;
}

/* Event type indicators */
.event-card.technical {
    border-left: 4px solid #3e64ff;
}

.event-card.non-technical {
    border-left: 4px solid #fb6340;
}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <!-- Filters and search -->
        <div class="col-12">
            <div class="event-filters">
                <div class="row">
                    <div class="col-md-9">
                        <div class="custom-tabs d-flex">
                            <div class="custom-tab active" data-tab="all-events">All Events</div>
                            <div class="custom-tab ms-2" data-tab="upcoming">Upcoming</div>
                            <div class="custom-tab ms-2" data-tab="past">Past</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control" id="eventSearch" placeholder="Search events...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <!-- Event list container -->
            <div id="all-events-content" class="tab-content active">
                <div id="events-container" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading events...</span>
                        </div>
                        <p class="mt-2">Loading your events...</p>
                    </div>
                </div>
            </div>
            
            <div id="upcoming-content" class="tab-content">
                <div id="upcoming-events-container" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading upcoming events...</span>
                        </div>
                        <p class="mt-2">Loading upcoming events...</p>
                    </div>
                </div>
            </div>
            
            <div id="past-content" class="tab-content">
                <div id="past-events-container" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading past events...</span>
                        </div>
                        <p class="mt-2">Loading past events...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4 mb-4">
        <a href="{{ url_for('organiser.create_event') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i> Create New Event
        </a>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteEventModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this event? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete Event</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Setup CSRF token for all AJAX requests
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", document.querySelector('meta[name="csrf-token"]').getAttribute('content'));
            }
        }
    });
    
    let eventsList = [];
    let currentEventIdToDelete = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tab functionality
        const tabButtons = document.querySelectorAll('.custom-tab');
        
        tabButtons.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabContainer = this.parentElement;
                const tabContents = document.querySelectorAll('.tab-content');
                
                // Remove active class from all tabs in this container
                tabContainer.querySelectorAll('.custom-tab').forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab contents
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Show selected tab content
                const tabName = this.getAttribute('data-tab');
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                // If clicking on a tab other than "all-events", load the specific events
                if (tabName !== 'all-events') {
                    loadFilteredEvents(tabName);
                }
            });
        });
        
        // Initialize search functionality
        const searchInput = document.getElementById('eventSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterEvents(this.value.toLowerCase());
            });
        }
        
        // Set up delete confirmation modal
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                if (currentEventIdToDelete) {
                    deleteEvent(currentEventIdToDelete);
                }
            });
        }
        
        // Add event listener for "Add Sub-event" button in events page
        const addSubEventBtn = document.getElementById('addSubEventBtn');
        if (addSubEventBtn) {
            addSubEventBtn.addEventListener('click', function() {
                showAddSubEventModal();
            });
        }
        
        // Set up toggle for sub-event price based on "is free" checkbox
        const subEventIsFreeCheck = document.getElementById('subEventIsFree');
        const subEventPriceContainer = document.getElementById('subEventPriceContainer');
        if (subEventIsFreeCheck && subEventPriceContainer) {
            subEventIsFreeCheck.addEventListener('change', function() {
                subEventPriceContainer.style.display = this.checked ? 'none' : 'block';
                if (this.checked) {
                    document.getElementById('subEventPrice').value = '0';
                }
            });
        }
        
        // Load all events initially
        loadEvents();
    });
    
    async function loadEvents() {
        try {
            const eventsContainer = document.getElementById('events-container');
            if (!eventsContainer) return;
            
            const response = await fetch('/api/organiser/events');
            const data = await response.json();
            
            if (data.success && data.events) {
                eventsList = data.events; // Store events for search/filtering
                
                if (data.events.length === 0) {
                    eventsContainer.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <p class="mb-0">You haven't created any events yet.</p>
                                <p class="mb-0">Click the "Create New Event" button to get started.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                displayEvents(data.events, eventsContainer);
            } else {
                eventsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <p>Failed to load events. Please try refreshing the page.</p>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('events-container').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <p>Error loading events. Please try again later.</p>
                    </div>
                </div>
            `;
        }
    }
    
    async function loadFilteredEvents(filter) {
        if (!eventsList || eventsList.length === 0) return;
        
        const now = new Date();
        const containerId = filter === 'upcoming' ? 'upcoming-events-container' : 
                           filter === 'past' ? 'past-events-container' : 
                           '';
        
        if (!containerId) return;
        
        const container = document.getElementById(containerId);
        let filteredEvents = [];
        
        switch (filter) {
            case 'upcoming':
                filteredEvents = eventsList.filter(event => {
                    // Use start_date for event filtering (date is deprecated)
                    const eventDate = event.start_date ? new Date(event.start_date) : null;
                    return eventDate >= now;
                });
                break;
                
            case 'past':
                filteredEvents = eventsList.filter(event => {
                    // Use start_date for event filtering (date is deprecated)
                    const eventDate = event.start_date ? new Date(event.start_date) : null;
                    return eventDate < now;
                });
                break;
        }
        
        if (filteredEvents.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <p class="mb-0">No ${filter} events found.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        displayEvents(filteredEvents, container);
    }
    
    function displayEvents(events, container) {
        let eventsHTML = '';
        
        events.forEach(event => {
            const tagClass = event.tag === 'technical' ? 'primary' : 'warning';
            const tagTextClass = event.tag === 'technical' ? '' : 'text-dark';
            
            eventsHTML += `
            <div class="col-md-4 mb-4">
                <div class="event-card ${event.tag}">
                    <div class="card-header">
                        <strong>${event.name}</strong>
                        <div class="event-actions">
                            <a href="/organiser/edit_event/${event.id}" class="action-btn edit" data-bs-toggle="tooltip" title="Edit Event">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="action-btn delete" onclick="showDeleteModal(${event.id})" data-bs-toggle="tooltip" title="Delete Event">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="badge bg-${tagClass} ${tagTextClass} mb-2">${event.tag}</span>
                                <div><i class="far fa-calendar-alt me-1"></i> ${event.start_date ? event.start_date : '<span class="text-muted">Date TBA</span>'}</div>
                                ${event.sub_events && event.sub_events.length > 0 ? 
                                `<div class="mt-2"><small><strong>Sub-events:</strong> ${event.sub_events.length}</small></div>` : ''}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">${event.registration_count || 0} Registrations</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        });
        
        container.innerHTML = `<div class="row">${eventsHTML}</div>`;
        
        // Initialize tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }
    
    function filterEvents(searchTerm) {
        if (!eventsList || eventsList.length === 0) return;
        
        const eventsContainer = document.getElementById('events-container');
        
        if (searchTerm.trim() === '') {
            displayEvents(eventsList, eventsContainer);
            return;
        }
        
        const filteredEvents = eventsList.filter(event => {
            return event.name.toLowerCase().includes(searchTerm) || 
                   event.description.toLowerCase().includes(searchTerm) ||
                   event.tag.toLowerCase().includes(searchTerm) ||
                   event.venue.toLowerCase().includes(searchTerm);
        });
        
        if (filteredEvents.length === 0) {
            eventsContainer.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-info">
                        <p class="mb-0">No events match your search for "${searchTerm}".</p>
                    </div>
                </div>
            `;
            return;
        }
        
        displayEvents(filteredEvents, eventsContainer);
    }
    
    function showDeleteModal(eventId) {
        currentEventIdToDelete = eventId;
        const modal = new bootstrap.Modal(document.getElementById('deleteEventModal'));
        modal.show();
    }
    
    async function deleteEvent(eventId) {
        try {
            // Get CSRF token if needed
            let csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            const response = await fetch(`/organiser/events/${eventId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            });
            const data = await response.json();
            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteEventModal'));
            if (modal) modal.hide();
            if (data.success) {
                // Show success message and reload events instantly
                Swal.fire({ icon: 'success', title: 'Deleted!', text: data.message });
                await loadEvents();
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.error || 'Could not delete event.' });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Error deleting event. Please try again.' });
            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteEventModal'));
            if (modal) modal.hide();
        }
    }
    
    // Enhanced function to preview sub-event themes with event data
    function previewSubEventTheme(theme) {
        // Prevent event propagation if called from inside a button
        if (event) {
            event.stopPropagation();
        }
        
        // Store the current theme for later use
        const previewFrame = document.getElementById('subEventThemePreviewFrame');
        previewFrame.setAttribute('data-current-theme', theme);
        
        // Get event name & description from form or use placeholder
        const subEventName = document.getElementById('subEventName').value || 'Sample Sub-Event';
        const subEventDescription = document.getElementById('subEventDescription').value || 'This is a sample sub-event description for preview purposes.';
        
        // Get dates and other details to make the preview more realistic
        const startDate = document.getElementById('subEventStartDate').value || new Date().toISOString().split('T')[0];
        const startTime = document.getElementById('subEventStartTime').value || '10:00';
        const venue = document.getElementById('subEventVenue').value || 'Conference Hall';
        
        // Set iframe source to preview the theme - Using direct route
        const previewUrl = `/preview_registration_theme/${theme}?event_name=${encodeURIComponent(subEventName)}&event_description=${encodeURIComponent(subEventDescription)}&venue=${encodeURIComponent(venue)}&start_date=${encodeURIComponent(startDate)}&start_time=${encodeURIComponent(startTime)}&is_preview=true`;
        
        // Update modal title with theme name and indication this is for a sub-event
        document.getElementById('subEventThemePreviewModalLabel').textContent = 
            `${theme.charAt(0).toUpperCase() + theme.slice(1)} Theme Preview (Sub-event)`;
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('subEventThemePreviewModal'));
        modal.show();
        
        // Set up onload handler to ensure theme is applied correctly in the iframe
        previewFrame.onload = function() {
            try {
                // Make sure theme styles are properly applied in the preview
                if (previewFrame.contentWindow.document.body) {
                    // First remove any existing theme classes
                    const body = previewFrame.contentWindow.document.body;
                    body.classList.remove('theme-minimalist', 'theme-tech', 'theme-creative', 'theme-elegant', 'theme-retro');
                    // Add the selected theme class
                    body.classList.add(`theme-${theme}`);
                }
            } catch(e) {
                console.error("Error updating theme preview:", e);
            }
        };
        
        // Set the iframe source after setting up the onload handler
        previewFrame.src = previewUrl;
    }

    // Set up the theme card selection and "Use This Theme" button
    document.addEventListener('DOMContentLoaded', function() {
        // Set up theme card selection behavior
        document.querySelectorAll('.sub-event-theme-card').forEach(card => {
            card.addEventListener('click', function() {
                // Update visual selection
                document.querySelectorAll('.sub-event-theme-card').forEach(c => c.style.border = '2px solid transparent');
                this.style.border = '2px solid #3e64ff';
                
                // Update hidden input
                const selectedTheme = this.getAttribute('data-theme');
                document.getElementById('subEventThemeInput').value = selectedTheme;
                
                // If inherit checkbox is checked, uncheck it since a specific theme was chosen
                const inheritCheckbox = document.getElementById('inheritFromParent');
                if (inheritCheckbox && inheritCheckbox.checked) {
                    inheritCheckbox.checked = false;
                }
            });
        });
        
        // Set up the "Use This Theme" button functionality
        const useSubEventThemeBtn = document.getElementById('useSubEventThemeBtn');
        if (useSubEventThemeBtn) {
            useSubEventThemeBtn.addEventListener('click', function() {
                const selectedTheme = document.getElementById('subEventThemePreviewFrame').getAttribute('data-current-theme');
                if (selectedTheme) {
                    // Update card selection
                    document.querySelectorAll('.sub-event-theme-card').forEach(card => {
                        card.style.border = '2px solid transparent';
                        if (card.getAttribute('data-theme') === selectedTheme) {
                            card.style.border = '2px solid #3e64ff';
                        }
                    });
                    
                    // Update hidden input
                    document.getElementById('subEventThemeInput').value = selectedTheme;
                    
                    // Uncheck inherit checkbox if it exists
                    const inheritCheckbox = document.getElementById('inheritFromParent');
                    if (inheritCheckbox && inheritCheckbox.checked) {
                        inheritCheckbox.checked = false;
                    }
                }
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('subEventThemePreviewModal'));
                modal.hide();
            });
        }
        
        // Handle inherit checkbox changes
        const inheritCheckbox = document.getElementById('inheritFromParent');
        if (inheritCheckbox) {
            inheritCheckbox.addEventListener('change', function() {
                const themeCards = document.querySelectorAll('.sub-event-theme-card');
                
                if (this.checked) {
                    // Gray out theme cards when inheriting
                    themeCards.forEach(card => {
                        card.style.opacity = '0.5';
                        card.style.pointerEvents = 'none';
                    });
                } else {
                    // Enable theme cards when not inheriting
                    themeCards.forEach(card => {
                        card.style.opacity = '1';
                        card.style.pointerEvents = 'auto';
                    });
                }
            });
            
            // Set initial state
            if (inheritCheckbox.checked) {
                document.querySelectorAll('.sub-event-theme-card').forEach(card => {
                    card.style.opacity = '0.5';
                    card.style.pointerEvents = 'none';
                });
            }
        }
    });
</script>
{% endblock %}