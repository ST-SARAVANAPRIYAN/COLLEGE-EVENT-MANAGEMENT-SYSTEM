{% extends 'organiser_base.html' %}

{% block title %}CEMS - Resource Management{% endblock %}

{% block extra_styles %}
.resource-card {
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    background-color: white;
    transition: transform 0.3s ease;
}

.resource-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.resource-type-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    display: inline-block;
    margin-bottom: 10px;
}

.resource-type-equipment {
    background-color: #e3f2fd;
    color: #0d6efd;
}

.resource-type-venue {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.resource-type-personnel {
    background-color: #fff8e1;
    color: #f57f17;
}

.resource-quantity {
    font-size: 14px;
    color: #6c757d;
}

.resource-quantity .available {
    color: #28a745;
    font-weight: 500;
}

.resource-quantity .allocated {
    color: #dc3545;
    font-weight: 500;
}

/* Wider progress bar */
.resource-card .progress {
    height: 18px;
    background: #f0f0f0;
    border-radius: 10px;
    margin-top: 8px;
}

.resource-card .progress-bar {
    font-size: 13px;
    font-weight: 500;
    border-radius: 10px;
    transition: width 0.5s, background 0.5s;
}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center">
                <h5>Manage Resources</h5>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#resourceModal">
                    <i class="fas fa-plus-circle me-2"></i> Add New Resource
                </button>
            </div>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" id="resourceSearch" class="form-control" placeholder="Search resources...">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div id="resourceList" class="resource-list">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading resources...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div id="pendingDeallocations" class="alert alert-warning" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="resourceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resourceModalLabel">Add New Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="resourceForm">
                    <div class="form-group">
                        <label for="resourceName">Resource Name*</label>
                        <input type="text" class="form-control" id="resourceName" required>
                    </div>
                    <div class="form-group">
                        <label for="resourceType">Resource Type*</label>
                        <select class="form-select" id="resourceType" required>
                            <option value="">Select type</option>
                            <option value="equipment">Equipment</option>
                            <option value="venue">Venue</option>
                            <option value="personnel">Personnel</option>
                            <option value="other">Other</option> <!-- Added Other option -->
                        </select>
                    </div>
                    <!-- Custom resource type input, shown only if 'Other' is selected -->
                    <div class="form-group" id="customResourceTypeGroup" style="display:none;">
                        <label for="customResourceType">Custom Resource Type*</label>
                        <input type="text" class="form-control" id="customResourceType">
                    </div>
                    <div class="form-group">
                        <label for="totalQuantity">Total Quantity*</label>
                        <input type="number" class="form-control" id="totalQuantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="resourceDescription">Description</label>
                        <textarea class="form-control" id="resourceDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="resourceImage">Resource Image (optional)</label>
                        <input type="file" class="form-control" id="resourceImage" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveResource">Save Resource</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Global variables
    let resources = [];
    let selectedResourceId = null;
    let isResourceLoading = false;

    // Optionally show auto-deallocation notification
    function showAutoDeallocationNotice(autoDeallocated) {
        if (autoDeallocated && autoDeallocated.length > 0) {
            Swal.fire({
                icon: 'info',
                title: 'Resource Auto-Deallocated',
                text: 'Some resources were automatically deallocated after organiser confirmation window expired.'
            });
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        await loadResources();
        await loadPendingDeallocations();
        
        // Set up event listeners
        document.getElementById('saveResource').addEventListener('click', saveResource);
        document.getElementById('resourceSearch').addEventListener('input', filterResources);
        // Show/hide custom resource type input
        document.getElementById('resourceType').addEventListener('change', function() {
            const customGroup = document.getElementById('customResourceTypeGroup');
            if (this.value === 'other') {
                customGroup.style.display = 'block';
                document.getElementById('customResourceType').setAttribute('required', 'required');
            } else {
                customGroup.style.display = 'none';
                document.getElementById('customResourceType').removeAttribute('required');
            }
        });
    });

    // Load resources with simplified error handling (no loading overlay or refresh notification)
    async function loadResources() {
        // Prevent concurrent loading
        if (isResourceLoading) {
            console.log('Resource loading already in progress, skipping request');
            return;
        }
        
        isResourceLoading = true;
        
        try {
            // Set timeout to prevent infinite loading
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 seconds timeout
            
            // Fetch resources with timeout
            const response = await fetch('/api/resources', {
                signal: controller.signal,
                headers: { 'Cache-Control': 'no-cache' } // Prevent caching
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            
            // Parse response
            const data = await response.json();
            
            // Validate response format
            if (!Array.isArray(data)) {
                console.error('Invalid response format:', data);
                throw new Error('Server returned invalid data format');
            }
            
            // Store resources globally
            resources = data;
            
            // Update UI
            renderResourcesList(resources);
            
            // Check for auto deallocations
            if (data.auto_deallocated && data.auto_deallocated.length > 0) {
                showAutoDeallocationNotice(data.auto_deallocated);
            }
            
        } catch (error) {
            console.error('Error loading resources:', error);
            document.getElementById('resourceList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Failed to load resources: ${error.message || 'Unknown error'}
                </div>
            `;
        } finally {
            isResourceLoading = false;
        }
    }

    // Render resources list (update to use 'category' for display and search)
    function renderResourcesList(resourcesList) {
        const container = document.getElementById('resourceList');
        
        if (resourcesList.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <p>No resources found. Add your first resource to get started.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        resourcesList.forEach(resource => {
            // Determine resource type class
            let typeClass = 'resource-type-equipment';
            if (resource.category === 'venue') typeClass = 'resource-type-venue';
            if (resource.category === 'personnel') typeClass = 'resource-type-personnel';
            
            // Calculate allocation percentage
            const allocated = resource.total_quantity - resource.available_quantity;
            const allocationPercentage = resource.total_quantity > 0 ? Math.round((allocated / resource.total_quantity) * 100) : 0;
            
            // Calculate color: blue (high availability) to red (low availability)
            // 0% allocated = blue (#007bff), 100% allocated = red (#dc3545)
            const percent = allocationPercentage / 100;
            const r = Math.round(0x00 + (0xdc - 0x00) * percent); // 0x00 to 0xdc
            const g = Math.round(0x7b + (0x34 - 0x7b) * percent); // 0x7b to 0x34
            const b = Math.round(0xff + (0x45 - 0xff) * percent); // 0xff to 0x45
            const barColor = `rgb(${r},${g},${b})`;
            
            html += `
                <div class="resource-card" data-resource-id="${resource.id}">
                    <div class="d-flex justify-content-between">
                        <div>
                            ${resource.image ? `<img src="/static/${resource.image}" alt="Resource Image" class="img-thumbnail mb-2" style="max-width: 100px; max-height: 70px;">` : ''}
                            <span class="resource-type-badge ${typeClass}">
                                ${resource.category ? resource.category.charAt(0).toUpperCase() + resource.category.slice(1) : 'Other'}
                            </span>
                            <h5>${resource.name}</h5>
                            <p class="resource-quantity">
                                <span class="available">${resource.available_quantity}</span> available /
                                <span class="allocated">${allocated}</span> allocated
                                out of ${resource.total_quantity} total
                            </p>
                            <p class="text-muted small">${resource.description || 'No description'}</p>
                        </div>
                        <div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editResource(${resource.id})">Edit</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="deleteResource(${resource.id})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 18px;">
                        <div class="progress-bar" role="progressbar" style="width: ${allocationPercentage}%; background: ${barColor};" aria-valuenow="${allocationPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add click listener to show allocations
        document.querySelectorAll('.resource-card').forEach(card => {
            card.addEventListener('click', function() {
                const resourceId = this.dataset.resourceId;
                selectedResourceId = resourceId;
                showResourceAllocations(resourceId);
                
                // Mark as selected
                document.querySelectorAll('.resource-card').forEach(c => c.classList.remove('border-primary'));
                this.classList.add('border-primary');
            });
        });
    }
    
    // Load pending deallocations
    async function loadPendingDeallocations() {
        try {
            const response = await fetch('/api/organiser/pending-deallocations');
            if (!response.ok) return;
            const data = await response.json();
            const container = document.getElementById('pendingDeallocations');            if (data.success && data.allocations && data.allocations.length > 0) {
                let html = '<div class="card border-warning mb-3"><div class="card-header bg-warning text-dark"><i class="fas fa-exclamation-triangle"></i> Pending Resource Deallocations</div><div class="card-body"><ul class="list-group">';
                data.allocations.forEach(a => {
                    // Format the end time nicely
                    const endTimeText = a.end_time ? `<small class="text-muted"><i class="far fa-clock"></i> Event ended: ${a.end_time}</small>` : '';
                    html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${a.resource_name}</strong> 
                            <div>Event: ${a.event_name}, Quantity: ${a.quantity}</div>
                            ${endTimeText}
                        </div>
                        <button class='btn btn-sm btn-success' onclick='confirmDeallocate(${a.allocation_id}, "${a.event_name}", "${a.resource_name}", ${a.quantity})'>
                            <i class="fas fa-check"></i> Confirm Return
                        </button>
                    </li>`;
                });
                html += '</ul></div></div>';
                container.innerHTML = html;
                container.style.display = '';
            } else {
                container.style.display = 'none';
            }
            // Show auto-deallocation notice if needed
            if (data.auto_deallocated && data.auto_deallocated.length > 0) {
                showAutoDeallocationNotice(data.auto_deallocated);
            }
        } catch (e) {
            document.getElementById('pendingDeallocations').style.display = 'none';
        }
    }    // Confirm deallocation with enhanced UI and error handling
    async function confirmDeallocate(allocationId, eventName = '', resourceName = '', quantity = 0) {
        // More descriptive confirmation dialog
        const result = await Swal.fire({
            title: 'Confirm Resource Return',
            html: `
                <div class="text-start">
                    <p>You are returning:</p>
                    <ul>
                        <li><strong>${quantity}x ${resourceName}</strong></li>
                        <li>From event: <strong>${eventName}</strong></li>
                    </ul>
                    <p>This will increase your available resource count.</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, return resources',
            cancelButtonText: 'Cancel',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d'
        });
        
        // Return if user cancels
        if (!result.isConfirmed) return;
        
        // Show processing state
        Swal.fire({
            title: 'Processing...',
            text: 'Returning resources to inventory',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        try {
            // Call API to deallocate
            const response = await fetch(`/api/resource-allocations/${allocationId}/deallocate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            // Parse response
            const data = await response.json();
            
            // Handle success case
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Resources Returned',
                    text: `${quantity}x ${resourceName} have been successfully returned to inventory`,
                    timer: 3000
                });
                
                // Update UI
                loadPendingDeallocations();
                await loadResources();
            } else {
                // Handle API errors
                Swal.fire({
                    icon: 'error',
                    title: 'Deallocation Failed',
                    text: data.error || 'Could not deallocate resource. Please try again.'
                });
            }
        } catch (error) {
            // Handle network or other errors
            console.error('Deallocation error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Connection Error',
                text: 'Failed to deallocate resource due to a network error. Please check your connection and try again.'
            });
        }
    }
    
    // Call this after deleting an event to optimally deallocate resources
    async function deallocateResourcesForDeletedEvent(eventId) {
        try {
            // Get all allocations for this event
            const response = await fetch(`/api/resources/by-event/${eventId}`);
            if (!response.ok) return;
            const allocations = await response.json();
            if (Array.isArray(allocations)) {
                for (const alloc of allocations) {
                    if (alloc.allocation && alloc.allocation.status === 'allocated') {
                        await fetch(`/api/resource-allocations/${alloc.allocation.id}/deallocate`, { method: 'POST' });
                    }
                }
            }
        } catch (e) {
            // Silent fail
        }
    }
    
    // Save new resource with enhanced exception handling and support for 'Other' type
    async function saveResource() {
        const name = document.getElementById('resourceName').value;
        let resourceType = document.getElementById('resourceType').value;
        const totalQuantity = parseInt(document.getElementById('totalQuantity').value);
        const description = document.getElementById('resourceDescription').value;
        const imageInput = document.getElementById('resourceImage');
        
        // If 'Other', get custom type
        if (resourceType === 'other') {
            resourceType = document.getElementById('customResourceType').value.trim();
        }
        
        if (!name || !resourceType || isNaN(totalQuantity) || totalQuantity < 1) {
            Swal.fire({ icon: 'warning', title: 'Missing Fields', text: 'Please fill in all required fields.' });
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', resourceType);
            formData.append('total_quantity', totalQuantity);
            formData.append('description', description);
            if (imageInput.files && imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }
            
            const response = await fetch('/api/resources', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('resourceModal')).hide();
                
                // Reset form
                document.getElementById('resourceForm').reset();
                
                // Reload resources
                await loadResources();
                
                // Show success message
                Swal.fire({ icon: 'success', title: 'Success', text: 'Resource created successfully!' });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: result.error || 'Could not create resource.' });
            }
        } catch (error) {
            console.error('Error saving resource:', error);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save resource. Please try again.' });
        }
    }
    
    // Show resource allocations
    async function showResourceAllocations(resourceId) {
        try {
            const response = await fetch(`/api/resources/${resourceId}/allocations`);
            const allocations = await response.json();
            const container = document.getElementById('allocationsList');
            if (!Array.isArray(allocations)) {
                container.innerHTML = `<div class="alert alert-danger">Failed to load allocations. Please try again.</div>`;
                return;
            }
            if (allocations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <p class="text-muted">No allocations for this resource</p>
                    </div>
                `;
                return;
            }
            let html = '';
            allocations.forEach(allocation => {
                // Use allocation.allocated_at for start, allocation.returned_at for end if available
                let startDate = allocation.allocation_start ? new Date(allocation.allocation_start) : null;
                let endDate = allocation.allocation_end ? new Date(allocation.allocation_end) : null;
                html += `
                    <div class="allocation-item mb-3">
                        <div class="d-flex justify-content-between">
                            <h6>${allocation.event_name}</h6>
                            <span class="badge ${allocation.status === 'allocated' ? 'bg-warning' : 'bg-success'}">
                                ${allocation.status}
                            </span>
                        </div>
                        <p class="small mb-1">
                            <i class="far fa-calendar"></i> 
                            ${startDate ? startDate.toLocaleDateString() : 'N/A'} to ${endDate ? endDate.toLocaleDateString() : 'Ongoing'}
                        </p>
                        <p class="small mb-0">
                            <i class="fas fa-hashtag"></i> 
                            Quantity: ${allocation.quantity}
                        </p>
                    </div>
                `;
            });
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading allocations:', error);
            document.getElementById('allocationsList').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load allocations. Please try again.
                </div>
            `;
        }
    }
    
    // Filter resources by search term (update to use 'category')
    function filterResources() {
        const searchTerm = document.getElementById('resourceSearch').value.toLowerCase();
        
        if (!searchTerm) {
            renderResourcesList(resources);
            return;
        }
        
        const filteredResources = resources.filter(resource => 
            resource.name.toLowerCase().includes(searchTerm) ||
            resource.description?.toLowerCase().includes(searchTerm) ||
            (resource.category && resource.category.toLowerCase().includes(searchTerm))
        );
        
        renderResourcesList(filteredResources);
    }
    
    // Edit resource (update to use 'category' and show allocated quantity)
    async function editResource(resourceId) {
        const resource = resources.find(r => r.id === resourceId);
        if (!resource) return;
        // Fetch allocated quantity from API
        let allocated = 0;
        try {
            const resp = await fetch(`/api/resources/${resourceId}/allocations`);
            const allocations = await resp.json();
            if (Array.isArray(allocations)) {
                allocated = allocations.filter(a => a.status === 'allocated').reduce((sum, a) => sum + a.quantity, 0);
            }
        } catch (e) { allocated = 0; }
        // Populate form
        document.getElementById('resourceName').value = resource.name;
        document.getElementById('resourceType').value = resource.category;
        document.getElementById('totalQuantity').value = resource.total_quantity;
        document.getElementById('resourceDescription').value = resource.description || '';
        // Show allocated info
        let allocInfo = document.getElementById('allocatedInfo');
        if (!allocInfo) {
            allocInfo = document.createElement('div');
            allocInfo.id = 'allocatedInfo';
            allocInfo.className = 'alert alert-info mt-2';
            document.getElementById('totalQuantity').parentElement.appendChild(allocInfo);
        }
        allocInfo.innerHTML = `<strong>Allocated:</strong> ${allocated} (You cannot set total quantity below this value)`;
        // Update modal title
        document.getElementById('resourceModalLabel').textContent = 'Edit Resource';
        // Update save button handler
        const saveButton = document.getElementById('saveResource');
        saveButton.removeEventListener('click', saveResource);
        saveButton.onclick = () => updateResource(resourceId, allocated);
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('resourceModal'));
        modal.show();
    }
    // Update resource with enhanced validation and error handling
    async function updateResource(resourceId, allocated) {
        const name = document.getElementById('resourceName').value;
        let resourceType = document.getElementById('resourceType').value;
        const totalQuantity = parseInt(document.getElementById('totalQuantity').value);
        const description = document.getElementById('resourceDescription').value;
        if (resourceType === 'other') {
            resourceType = document.getElementById('customResourceType').value.trim();
        }
        if (!name || !resourceType || isNaN(totalQuantity) || totalQuantity < 1) {
            Swal.fire({ icon: 'warning', title: 'Missing Fields', text: 'Please fill in all required fields.' });
            return;
        }
        if (totalQuantity < allocated) {
            Swal.fire({ icon: 'error', title: 'Invalid Quantity', text: `Total quantity cannot be less than allocated (${allocated}).` });
            return;
        }
        try {
            const response = await fetch(`/api/resources/${resourceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, category: resourceType, total_quantity: totalQuantity, description })
            });
            const result = await response.json();
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('resourceModal')).hide();
                document.getElementById('resourceForm').reset();
                document.getElementById('resourceModalLabel').textContent = 'Add New Resource';
                const saveButton = document.getElementById('saveResource');
                saveButton.removeEventListener('click', () => updateResource(resourceId, allocated));
                saveButton.addEventListener('click', saveResource);
                await loadResources();
                Swal.fire({ icon: 'success', title: 'Success', text: 'Resource updated successfully!' });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: result.error || 'Could not update resource.' });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to update resource. Please try again.' });
        }
    }
    
    // Delete resource with confirmation using Swal.fire
    async function deleteResource(resourceId) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: 'Do you want to delete this resource?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        });
        
        if (!result.isConfirmed) return;
        
        try {
            const response = await fetch(`/api/resources/${resourceId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Reload resources
                await loadResources();
                
                // Show success message
                Swal.fire({ icon: 'success', title: 'Deleted!', text: 'Resource deleted successfully!' });
            } else {
                const error = await response.json();
                Swal.fire({ icon: 'error', title: 'Error', text: error.error || 'Could not delete resource.' });
            }
        } catch (error) {
            console.error('Error deleting resource:', error);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete resource. Please try again.' });
        }
    }
    
    // Delete event with enhanced error handling and Swal.fire feedback
    async function deleteEvent(eventId) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: 'Do you want to delete this event? All resource allocations will be deallocated.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        });
        if (!result.isConfirmed) return;
        try {
            const response = await fetch(`/api/organiser/events/${eventId}`, { method: 'DELETE' });
            const data = await response.json();
            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Deleted!', text: data.message });
                await loadResources();
                await loadPendingDeallocations();
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.error || 'Could not delete event.' });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete event. Please try again.' });
        }
    }
</script>
{% endblock %}