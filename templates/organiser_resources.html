{% extends 'organiser_base.html' %}

{% block title %}CEMS - Resource Management{% endblock %}

{% block page_title %}Resource Management{% endblock %}

{% block extra_styles %}
.resource-card {
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    background-color: white;
    transition: transform 0.3s ease;
}

.resource-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
}

.resource-type-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    display: inline-block;
    margin-bottom: 10px;
}

.resource-type-equipment {
    background-color: #e3f2fd;
    color: #0d6efd;
}

.resource-type-venue {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.resource-type-personnel {
    background-color: #fff8e1;
    color: #f57f17;
}

.resource-quantity {
    font-size: 14px;
    color: #6c757d;
}

.resource-quantity .available {
    color: #28a745;
    font-weight: 500;
}

.resource-quantity .allocated {
    color: #dc3545;
    font-weight: 500;
}

#resourceModal .form-group {
    margin-bottom: 15px;
}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center">
                <h5>Manage Resources</h5>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#resourceModal">
                    <i class="fas fa-plus-circle me-2"></i> Add New Resource
                </button>
            </div>
        </div>
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" id="resourceSearch" class="form-control" placeholder="Search resources...">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div id="resourceList" class="resource-list">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading resources...</span>
                    </div>
                    <p class="mt-2">Loading resources...</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card custom-card">
                <div class="card-title">
                    <h5>Resource Allocations</h5>
                </div>
                <div class="card-body" id="allocationsList">
                    <div class="text-center py-3">
                        <p class="text-muted">Select a resource to see allocations</p>
                    </div>
                </div>
            </div>
            
            <div class="card custom-card mt-4">
                <div class="card-title d-flex justify-content-between align-items-center">
                    <h5>Resource Usage</h5>
                    <button id="refreshResourceChart" class="btn btn-sm btn-outline-primary" title="Refresh Resource Usage">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body p-0 position-relative" id="resourceChartContainer">
                    <div id="resourceChartLoading" class="position-absolute w-100 h-100 d-flex justify-content-center align-items-center" style="background:rgba(255,255,255,0.7);z-index:2;display:none;">
                        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>
                    <canvas id="resourceUsageChart" style="width: 100%; height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div id="pendingDeallocations" class="alert alert-warning" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Add Resource Modal -->
<div class="modal fade" id="resourceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resourceModalLabel">Add New Resource</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="resourceForm">
                    <div class="form-group">
                        <label for="resourceName">Resource Name*</label>
                        <input type="text" class="form-control" id="resourceName" required>
                    </div>
                    <div class="form-group">
                        <label for="resourceType">Resource Type*</label>
                        <select class="form-select" id="resourceType" required>
                            <option value="">Select type</option>
                            <option value="equipment">Equipment</option>
                            <option value="venue">Venue</option>
                            <option value="personnel">Personnel</option>
                            <option value="other">Other</option> <!-- Added Other option -->
                        </select>
                    </div>
                    <!-- Custom resource type input, shown only if 'Other' is selected -->
                    <div class="form-group" id="customResourceTypeGroup" style="display:none;">
                        <label for="customResourceType">Custom Resource Type*</label>
                        <input type="text" class="form-control" id="customResourceType">
                    </div>
                    <div class="form-group">
                        <label for="totalQuantity">Total Quantity*</label>
                        <input type="number" class="form-control" id="totalQuantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="resourceDescription">Description</label>
                        <textarea class="form-control" id="resourceDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="resourceImage">Resource Image (optional)</label>
                        <input type="file" class="form-control" id="resourceImage" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveResource">Save Resource</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Global variables
    let resources = [];
    let resourceUsageChart = null;
    let selectedResourceId = null;
    let isResourceLoading = false;

    // Optionally show auto-deallocation notification
    function showAutoDeallocationNotice(autoDeallocated) {
        if (autoDeallocated && autoDeallocated.length > 0) {
            Swal.fire({
                icon: 'info',
                title: 'Resource Auto-Deallocated',
                text: 'Some resources were automatically deallocated after organiser confirmation window expired.'
            });
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        await loadResources();
        initializeResourceChart();
        await loadPendingDeallocations();
        
        // Set up event listeners
        document.getElementById('saveResource').addEventListener('click', saveResource);
        document.getElementById('resourceSearch').addEventListener('input', filterResources);
        // Show/hide custom resource type input
        document.getElementById('resourceType').addEventListener('change', function() {
            const customGroup = document.getElementById('customResourceTypeGroup');
            if (this.value === 'other') {
                customGroup.style.display = 'block';
                document.getElementById('customResourceType').setAttribute('required', 'required');
            } else {
                customGroup.style.display = 'none';
                document.getElementById('customResourceType').removeAttribute('required');
            }
        });

        document.getElementById('refreshResourceChart').addEventListener('click', async function() {
            if (isResourceLoading) return;
            showResourceChartLoading(true);
            await loadResources();
            showResourceChartLoading(false);
        });
    });

    function showResourceChartLoading(show) {
        const loadingDiv = document.getElementById('resourceChartLoading');
        const refreshBtn = document.getElementById('refreshResourceChart');
        if (loadingDiv) loadingDiv.style.display = show ? '' : 'none';
        if (refreshBtn) refreshBtn.disabled = show;
    }
    
    // Load resources
    async function loadResources() {
        if (isResourceLoading) return;
        isResourceLoading = true;
        try {
            showResourceChartLoading(true);
            const response = await fetch('/api/resources');
            resources = await response.json();
            renderResourcesList(resources);
            updateResourceChart(resources); // Update chart with new data
            showAutoDeallocationNotice(resources.auto_deallocated); // Check for auto-deallocation
        } catch (error) {
            console.error('Error loading resources:', error);
            document.getElementById('resourceList').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load resources. Please try again later.
                </div>
            `;
        } finally {
            showResourceChartLoading(false);
            isResourceLoading = false;
        }
    }

    // Update resource usage chart with current data
    function updateResourceChart(resourcesList) {
        if (!resourceUsageChart) return;
        let total = 0, allocated = 0;
        resourcesList.forEach(resource => {
            total += Number(resource.total_quantity);
            allocated += (Number(resource.total_quantity) - Number(resource.available_quantity));
        });
        // Prevent negative and NaN values
        const available = Math.max(total - allocated, 0);
        // Defensive: If all allocated, show all red; if all available, all green
        let chartData;
        if (total === 0) {
            chartData = [1, 0];
        } else if (allocated === 0) {
            chartData = [total, 0];
        } else if (available === 0) {
            chartData = [0, total];
        } else {
            chartData = [available, allocated];
        }
        resourceUsageChart.data.datasets[0].data = chartData;
        // Add dynamic labels for clarity
        resourceUsageChart.data.labels = [
            `Available (${available})`,
            `Allocated (${allocated})`
        ];
        resourceUsageChart.update();
    }
    
    // Load pending deallocations
    async function loadPendingDeallocations() {
        try {
            const response = await fetch('/api/organiser/pending-deallocations');
            if (!response.ok) return;
            const data = await response.json();
            const container = document.getElementById('pendingDeallocations');
            if (data.success && data.allocations && data.allocations.length > 0) {
                let html = '<strong>Confirm Resource Deallocation:</strong><ul>';
                data.allocations.forEach(a => {
                    html += `<li>${a.resource_name} (Event: ${a.event_name}, Quantity: ${a.quantity}) <button class='btn btn-sm btn-success ms-2' onclick='confirmDeallocate(${a.allocation_id})'>Confirm Return</button></li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
                container.style.display = '';
            } else {
                container.style.display = 'none';
            }
            // Show auto-deallocation notice if needed
            if (data.auto_deallocated && data.auto_deallocated.length > 0) {
                showAutoDeallocationNotice(data.auto_deallocated);
            }
        } catch (e) {
            document.getElementById('pendingDeallocations').style.display = 'none';
        }
    }

    // Confirm deallocation
    async function confirmDeallocate(allocationId) {
        const result = await Swal.fire({
            title: 'Confirm Deallocation',
            text: 'Are you sure you want to return this resource?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, return',
            cancelButtonText: 'Cancel'
        });
        if (!result.isConfirmed) return;
        try {
            const response = await fetch(`/api/resource-allocations/${allocationId}/deallocate`, { method: 'POST' });
            const data = await response.json();
            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Resource Returned', text: data.message });
                loadPendingDeallocations();
                await loadResources();
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.error || 'Could not deallocate resource.' });
            }
        } catch (e) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to deallocate resource.' });
        }
    }
    
    // Call this after deleting an event to optimally deallocate resources
    async function deallocateResourcesForDeletedEvent(eventId) {
        try {
            // Get all allocations for this event
            const response = await fetch(`/api/resources/by-event/${eventId}`);
            if (!response.ok) return;
            const allocations = await response.json();
            if (Array.isArray(allocations)) {
                for (const alloc of allocations) {
                    if (alloc.allocation && alloc.allocation.status === 'allocated') {
                        await fetch(`/api/resource-allocations/${alloc.allocation.id}/deallocate`, { method: 'POST' });
                    }
                }
            }
        } catch (e) {
            // Silent fail
        }
    }
    
    // Render resources list (update to use 'category' for display and search)
    function renderResourcesList(resourcesList) {
        const container = document.getElementById('resourceList');
        
        if (resourcesList.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <p>No resources found. Add your first resource to get started.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        resourcesList.forEach(resource => {
            // Determine resource type class
            let typeClass = 'resource-type-equipment';
            if (resource.category === 'venue') typeClass = 'resource-type-venue';
            if (resource.category === 'personnel') typeClass = 'resource-type-personnel';
            
            // Calculate allocation percentage
            const allocated = resource.total_quantity - resource.available_quantity;
            const allocationPercentage = Math.round((allocated / resource.total_quantity) * 100);
            
            html += `
                <div class="resource-card" data-resource-id="${resource.id}">
                    <div class="d-flex justify-content-between">
                        <div>
                            ${resource.image ? `<img src="/static/${resource.image}" alt="Resource Image" class="img-thumbnail mb-2" style="max-width: 100px; max-height: 70px;">` : ''}
                            <span class="resource-type-badge ${typeClass}">
                                ${resource.category ? resource.category.charAt(0).toUpperCase() + resource.category.slice(1) : 'Other'}
                            </span>
                            <h5>${resource.name}</h5>
                            <p class="resource-quantity">
                                <span class="available">${resource.available_quantity}</span> available / 
                                <span class="allocated">${allocated}</span> allocated
                                out of ${resource.total_quantity} total
                            </p>
                            <p class="text-muted small">${resource.description || 'No description'}</p>
                        </div>
                        <div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editResource(${resource.id})">Edit</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="deleteResource(${resource.id})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" style="width: ${allocationPercentage}%;" 
                             aria-valuenow="${allocationPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add click listener to show allocations
        document.querySelectorAll('.resource-card').forEach(card => {
            card.addEventListener('click', function() {
                const resourceId = this.dataset.resourceId;
                selectedResourceId = resourceId;
                showResourceAllocations(resourceId);
                
                // Mark as selected
                document.querySelectorAll('.resource-card').forEach(c => c.classList.remove('border-primary'));
                this.classList.add('border-primary');
            });
        });
    }
    
    // Save new resource with enhanced exception handling and support for 'Other' type
    async function saveResource() {
        const name = document.getElementById('resourceName').value;
        let resourceType = document.getElementById('resourceType').value;
        const totalQuantity = parseInt(document.getElementById('totalQuantity').value);
        const description = document.getElementById('resourceDescription').value;
        const imageInput = document.getElementById('resourceImage');
        
        // If 'Other', get custom type
        if (resourceType === 'other') {
            resourceType = document.getElementById('customResourceType').value.trim();
        }
        
        if (!name || !resourceType || isNaN(totalQuantity) || totalQuantity < 1) {
            Swal.fire({ icon: 'warning', title: 'Missing Fields', text: 'Please fill in all required fields.' });
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', resourceType);
            formData.append('total_quantity', totalQuantity);
            formData.append('description', description);
            if (imageInput.files && imageInput.files[0]) {
                formData.append('image', imageInput.files[0]);
            }
            
            const response = await fetch('/api/resources', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('resourceModal')).hide();
                
                // Reset form
                document.getElementById('resourceForm').reset();
                
                // Reload resources
                await loadResources();
                
                // Show success message
                Swal.fire({ icon: 'success', title: 'Success', text: 'Resource created successfully!' });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: result.error || 'Could not create resource.' });
            }
        } catch (error) {
            console.error('Error saving resource:', error);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to save resource. Please try again.' });
        }
    }
    
    // Show resource allocations
    async function showResourceAllocations(resourceId) {
        try {
            const response = await fetch(`/api/resources/${resourceId}/allocations`);
            const allocations = await response.json();
            const container = document.getElementById('allocationsList');
            if (!Array.isArray(allocations)) {
                container.innerHTML = `<div class="alert alert-danger">Failed to load allocations. Please try again.</div>`;
                return;
            }
            if (allocations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3">
                        <p class="text-muted">No allocations for this resource</p>
                    </div>
                `;
                return;
            }
            let html = '';
            allocations.forEach(allocation => {
                // Use allocation.allocated_at for start, allocation.returned_at for end if available
                let startDate = allocation.allocation_start ? new Date(allocation.allocation_start) : null;
                let endDate = allocation.allocation_end ? new Date(allocation.allocation_end) : null;
                html += `
                    <div class="allocation-item mb-3">
                        <div class="d-flex justify-content-between">
                            <h6>${allocation.event_name}</h6>
                            <span class="badge ${allocation.status === 'allocated' ? 'bg-warning' : 'bg-success'}">
                                ${allocation.status}
                            </span>
                        </div>
                        <p class="small mb-1">
                            <i class="far fa-calendar"></i> 
                            ${startDate ? startDate.toLocaleDateString() : 'N/A'} to ${endDate ? endDate.toLocaleDateString() : 'Ongoing'}
                        </p>
                        <p class="small mb-0">
                            <i class="fas fa-hashtag"></i> 
                            Quantity: ${allocation.quantity}
                        </p>
                    </div>
                `;
            });
            container.innerHTML = html;
        } catch (error) {
            console.error('Error loading allocations:', error);
            document.getElementById('allocationsList').innerHTML = `
                <div class="alert alert-danger">
                    Failed to load allocations. Please try again.
                </div>
            `;
        }
    }
    
    // Filter resources by search term (update to use 'category')
    function filterResources() {
        const searchTerm = document.getElementById('resourceSearch').value.toLowerCase();
        
        if (!searchTerm) {
            renderResourcesList(resources);
            return;
        }
        
        const filteredResources = resources.filter(resource => 
            resource.name.toLowerCase().includes(searchTerm) ||
            resource.description?.toLowerCase().includes(searchTerm) ||
            (resource.category && resource.category.toLowerCase().includes(searchTerm))
        );
        
        renderResourcesList(filteredResources);
    }
    
    // Edit resource (update to use 'category')
    async function editResource(resourceId) {
        const resource = resources.find(r => r.id === resourceId);
        if (!resource) return;
        
        // Populate form
        document.getElementById('resourceName').value = resource.name;
        document.getElementById('resourceType').value = resource.category;
        document.getElementById('totalQuantity').value = resource.total_quantity;
        document.getElementById('resourceDescription').value = resource.description || '';
        
        // Update modal title
        document.getElementById('resourceModalLabel').textContent = 'Edit Resource';
        
        // Update save button handler
        const saveButton = document.getElementById('saveResource');
        saveButton.removeEventListener('click', saveResource);
        saveButton.addEventListener('click', () => updateResource(resourceId));
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('resourceModal'));
        modal.show();
    }
    
    // Update resource with enhanced exception handling and support for 'Other' type
    async function updateResource(resourceId) {
        // Similar to saveResource but using PUT request
        const name = document.getElementById('resourceName').value;
        let resourceType = document.getElementById('resourceType').value;
        const totalQuantity = parseInt(document.getElementById('totalQuantity').value);
        const description = document.getElementById('resourceDescription').value;
        
        if (resourceType === 'other') {
            resourceType = document.getElementById('customResourceType').value.trim();
        }
        
        if (!name || !resourceType || isNaN(totalQuantity) || totalQuantity < 1) {
            Swal.fire({ icon: 'warning', title: 'Missing Fields', text: 'Please fill in all required fields.' });
            return;
        }
        
        try {
            const response = await fetch(`/api/resources/${resourceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name,
                    category: resourceType, // Use 'category' instead of 'resource_type'
                    total_quantity: totalQuantity,
                    description
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('resourceModal')).hide();
                
                // Reset form and title
                document.getElementById('resourceForm').reset();
                document.getElementById('resourceModalLabel').textContent = 'Add New Resource';
                
                // Reset save button handler
                const saveButton = document.getElementById('saveResource');
                saveButton.removeEventListener('click', () => updateResource(resourceId));
                saveButton.addEventListener('click', saveResource);
                
                // Reload resources
                await loadResources();
                
                // Show success message
                Swal.fire({ icon: 'success', title: 'Success', text: 'Resource updated successfully!' });
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: result.error || 'Could not update resource.' });
            }
        } catch (error) {
            console.error('Error updating resource:', error);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to update resource. Please try again.' });
        }
    }
    
    // Delete resource with confirmation using Swal.fire
    async function deleteResource(resourceId) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: 'Do you want to delete this resource?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        });
        
        if (!result.isConfirmed) return;
        
        try {
            const response = await fetch(`/api/resources/${resourceId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Reload resources
                await loadResources();
                
                // Show success message
                Swal.fire({ icon: 'success', title: 'Deleted!', text: 'Resource deleted successfully!' });
            } else {
                const error = await response.json();
                Swal.fire({ icon: 'error', title: 'Error', text: error.error || 'Could not delete resource.' });
            }
        } catch (error) {
            console.error('Error deleting resource:', error);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete resource. Please try again.' });
        }
    }
    
    // Delete event with enhanced error handling and Swal.fire feedback
    async function deleteEvent(eventId) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: 'Do you want to delete this event? All resource allocations will be deallocated.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        });
        if (!result.isConfirmed) return;
        try {
            const response = await fetch(`/api/organiser/events/${eventId}`, { method: 'DELETE' });
            const data = await response.json();
            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Deleted!', text: data.message });
                await loadResources();
                await loadPendingDeallocations();
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.error || 'Could not delete event.' });
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to delete event. Please try again.' });
        }
    }

    // Initialize resource usage chart
    function initializeResourceChart() {
        const ctx = document.getElementById('resourceUsageChart');
        if(ctx) {
            resourceUsageChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Allocated'],
                    datasets: [{
                        data: [100, 0],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Resource Allocation'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.chart._metasets[0].total;
                                    const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
    }
</script>
{% endblock %}