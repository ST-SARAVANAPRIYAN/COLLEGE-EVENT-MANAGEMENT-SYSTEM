<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participant Dashboard | CEMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">CEMS</a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">Welcome, {{ session.user_name }}</span>
                <a href="/logout" class="btn btn-outline-light">Logout</a>
            </div>
        </div>
    </nav>
    <div class="container my-4">
        <h2 class="mb-4">Participant Dashboard</h2>
        <div class="row g-4">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">Available Events</div>
                    <div class="card-body" id="participant-events-list">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading events...</span>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">My Registrations</div>
                    <div class="card-body" id="my-registrations-list">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading registrations...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mb-4" id="event-detail-card" style="display: none;">
                    <div class="card-header bg-primary text-white">Event Details</div>
                    <div class="card-body" id="event-detail-content">
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">Notifications</div>
                    <div class="card-body" id="notifications-list">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading notifications...</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header bg-secondary text-white">Quick Links</div>
                    <div class="card-body">
                        <a href="/" class="btn btn-outline-info w-100 mb-2">Back to Home Page</a>
                        <div id="payment-section" class="mt-3">
                            <h6>Need Help?</h6>
                            <p class="small text-muted">If you're experiencing any issues with event registration or payment, please contact the event support team.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="payment-details">
                        <p><strong>Event:</strong> <span id="payment-event-name"></span></p>
                        <p><strong>Amount:</strong> â‚¹<span id="payment-amount"></span></p>
                        <div id="razorpay-button"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
    // Get all events
    async function getEvents() {
        try {
            const response = await fetch('/api/events');
            if (!response.ok) throw new Error('Failed to fetch events');
            const events = await response.json();
            return events;
        } catch (error) {
            console.error('Error fetching events:', error);
            return [];
        }
    }

    // Get user's registrations
    async function getMyRegistrations() {
        try {
            const response = await fetch('/api/my_registrations');
            if (!response.ok) throw new Error('Failed to fetch registrations');
            const registrations = await response.json();
            return registrations;
        } catch (error) {
            console.error('Error fetching registrations:', error);
            return [];
        }
    }

    // Get user's notifications
    async function getMyNotifications() {
        try {
            const response = await fetch('/api/my_notifications');
            if (!response.ok) throw new Error('Failed to fetch notifications');
            const notifications = await response.json();
            return notifications;
        } catch (error) {
            console.error('Error fetching notifications:', error);
            return [];
        }
    }

    // Register for an event
    async function registerForEvent(eventId) {
        try {
            const response = await fetch(`/api/events/${eventId}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Registration failed');
            }
            
            const result = await response.json();
            
            // If payment is required, show payment modal
            if (result.requires_payment) {
                showPaymentModal(result.payment_details);
            } else {
                alert('Registration successful!');
                // Reload registrations
                await loadMyRegistrations();
            }
            
            return result;
        } catch (error) {
            alert('Error: ' + error.message);
            console.error('Error registering for event:', error);
        }
    }

    // Mark notification as read
    async function markNotificationAsRead(notificationId) {
        try {
            const response = await fetch(`/api/mark_notification_read/${notificationId}`, {
                method: 'POST'
            });
            if (!response.ok) throw new Error('Failed to mark notification as read');
            // Update the notification in the UI
            document.querySelector(`#notification-${notificationId}`).classList.remove('unread-notification');
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    // Show Razorpay payment modal
    function showPaymentModal(paymentDetails) {
        document.getElementById('payment-event-name').textContent = paymentDetails.description.replace('Registration for ', '');
        document.getElementById('payment-amount').textContent = (paymentDetails.amount / 100).toFixed(2);
        
        const options = {
            key: paymentDetails.key_id,
            amount: paymentDetails.amount,
            currency: paymentDetails.currency,
            name: paymentDetails.name,
            description: paymentDetails.description,
            order_id: paymentDetails.order_id,
            prefill: {
                name: paymentDetails.prefill.name,
                email: paymentDetails.prefill.email
            },
            handler: function(response) {
                verifyPayment(response.razorpay_payment_id, paymentDetails.registration_id);
            },
            theme: {
                color: '#3399cc'
            }
        };
        
        const paymentObject = new Razorpay(options);
        document.getElementById('razorpay-button').innerHTML = '';
        const payButton = document.createElement('button');
        payButton.className = 'btn btn-primary w-100';
        payButton.innerText = 'Pay Now';
        payButton.onclick = function() {
            paymentObject.open();
        };
        document.getElementById('razorpay-button').appendChild(payButton);
        
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        paymentModal.show();
    }

    // Verify payment with backend
    async function verifyPayment(paymentId, registrationId) {
        try {
            const response = await fetch('/api/payments/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    payment_id: paymentId,
                    registration_id: registrationId
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Payment verification failed');
            }
            
            alert('Payment successful! Your registration is confirmed.');
            
            // Close the payment modal
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            
            // Reload registrations
            await loadMyRegistrations();
            
        } catch (error) {
            alert('Error: ' + error.message);
            console.error('Error verifying payment:', error);
        }
    }

    // Render events list
    function renderEventsList(events, registrations) {
        const list = document.getElementById('participant-events-list');
        
        // Create a map of registered event IDs for easy lookup
        const registeredEventIds = new Map();
        registrations.forEach(reg => {
            registeredEventIds.set(reg.event_id, reg);
        });
        
        if (events.length === 0) {
            list.innerHTML = '<p class="text-muted">No events available.</p>';
            return;
        }
        
        list.innerHTML = events.map(ev => {
            const isRegistered = registeredEventIds.has(ev.id);
            
            // Determine card style based on event tag
            let cardClass = 'card mb-2';
            if (ev.tag === 'technical') {
                cardClass += ' technical-card'; // Add CSS for neon tech-style in style.css
            } else if (ev.tag === 'non-technical') {
                cardClass += ' non-technical-card'; // Add CSS for fun-style in style.css
            }
            
            return `
                <div class='${cardClass}' data-event-id="${ev.id}">
                    <div class='card-body'>
                        <div class='d-flex justify-content-between align-items-center mb-2'>
                            <div>
                                <strong>${ev.name}</strong> 
                                <span class='badge ${ev.tag==='technical'?'bg-primary':'bg-warning text-dark'} ms-2'>${ev.tag}</span>
                            </div>
                            <span class='badge bg-info'>â‚¹${ev.fee}</span>
                        </div>
                        <div class='d-flex justify-content-between align-items-center'>
                            <small class='text-muted'>${ev.date}</small>
                            <div>
                                <button class='btn btn-outline-success btn-sm' 
                                        ${isRegistered?'disabled':''} 
                                        onclick="${isRegistered ? '' : `registerForEvent(${ev.id})`}">
                                    ${isRegistered?'Registered':'Register'}
                                </button>
                                ${ev.has_exploration ? 
                                    `<a href='/event_exploration/${ev.id}' target='_blank' class='btn btn-outline-primary btn-sm ms-2'>Explore</a>` : ''}
                                <button class='btn btn-outline-info btn-sm ms-2' onclick="showEventDetails(${ev.id})">
                                    Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Render registrations list
    function renderRegistrationsList(registrations) {
        const list = document.getElementById('my-registrations-list');
        
        if (registrations.length === 0) {
            list.innerHTML = '<p class="text-muted">No registrations found. Register for events to see them here.</p>';
            return;
        }
        
        list.innerHTML = registrations.map(reg => {
            return `
                <div class='card mb-2'>
                    <div class='card-body'>
                        <div class='d-flex justify-content-between align-items-center mb-2'>
                            <div>
                                <strong>${reg.event_name}</strong> 
                                <span class='badge ${reg.event_tag==='technical'?'bg-primary':'bg-warning text-dark'} ms-2'>${reg.event_tag}</span>
                            </div>
                            <span class='badge ${reg.payment_status==='completed'?'bg-success':'bg-warning text-dark'}'>${reg.payment_status}</span>
                        </div>
                        <div class='d-flex justify-content-between align-items-center'>
                            <small class='text-muted'>Date: ${reg.event_date} | Registered on: ${reg.registration_date}</small>
                            <div>
                                ${reg.has_exploration ? 
                                    `<a href='/event_exploration/${reg.event_id}' target='_blank' class='btn btn-outline-primary btn-sm'>Explore</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Render notifications list
    function renderNotificationsList(notifications) {
        const list = document.getElementById('notifications-list');
        
        if (notifications.length === 0) {
            list.innerHTML = '<p class="text-muted">No notifications.</p>';
            return;
        }
        
        list.innerHTML = notifications.map(notification => {
            const notificationClass = notification.is_read ? '' : 'unread-notification';
            
            return `
                <div id="notification-${notification.id}" class="notification-item ${notificationClass} mb-2 p-2" 
                     onclick="markNotificationAsRead(${notification.id})">
                    <p class="mb-1">${notification.message}</p>
                    <small class="text-muted">${new Date(notification.created_at).toLocaleString()}</small>
                </div>
            `;
        }).join('');
    }

    // Show event details
    async function showEventDetails(eventId) {
        try {
            const response = await fetch(`/api/events/${eventId}`);
            if (!response.ok) throw new Error('Failed to fetch event details');
            
            const event = await response.json();
            const detailCard = document.getElementById('event-detail-card');
            const detailContent = document.getElementById('event-detail-content');
            
            // Determine style based on event tag
            let headerClass = 'bg-primary';
            if (event.tag === 'technical') {
                headerClass = 'bg-primary technical-header';
            } else if (event.tag === 'non-technical') {
                headerClass = 'bg-warning text-dark non-technical-header';
            }
            
            // Update card header
            detailCard.querySelector('.card-header').className = `card-header ${headerClass} text-white`;
            detailCard.querySelector('.card-header').textContent = event.name;
            
            // Build detail content
            let content = `
                <p><strong>Date:</strong> ${event.date}</p>
                <p><strong>Fee:</strong> â‚¹${event.fee}</p>
                <p><strong>Description:</strong><br>${event.description || 'No description available.'}</p>
            `;
            
            // Add media if available
            if (event.image) {
                content += `<img src="${event.image}" class="img-fluid rounded mb-3" alt="${event.name}">`;
            }
            
            if (event.video) {
                content += `
                <div class="ratio ratio-16x9 mb-3">
                    <video controls>
                        <source src="${event.video}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>`;
            }
            
            // Add brochure download if available
            if (event.brochure) {
                content += `<a href="${event.brochure}" class="btn btn-outline-info w-100 mb-2" download>Download Brochure</a>`;
            }
            
            // Add exploration link if available
            if (event.has_exploration) {
                content += `<a href="/event_exploration/${event.id}" target="_blank" class="btn btn-primary w-100">Explore Event</a>`;
            }
            
            detailContent.innerHTML = content;
            detailCard.style.display = 'block';
            
        } catch (error) {
            console.error('Error showing event details:', error);
        }
    }

    // Load events
    async function loadEvents() {
        const events = await getEvents();
        const registrations = await getMyRegistrations();
        renderEventsList(events, registrations);
    }

    // Load registrations
    async function loadMyRegistrations() {
        const registrations = await getMyRegistrations();
        renderRegistrationsList(registrations);
    }

    // Load notifications
    async function loadNotifications() {
        const notifications = await getMyNotifications();
        renderNotificationsList(notifications);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
        await loadEvents();
        await loadMyRegistrations();
        await loadNotifications();
    });
    </script>
</body>
</html>
