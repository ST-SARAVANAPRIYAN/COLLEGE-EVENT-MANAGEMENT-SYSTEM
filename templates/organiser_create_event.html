{% extends 'organiser_base.html' %}

{% block title %}CEMS - Create Event{% endblock %}
{% block page_title %}Create Event{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
<script src="https://unpkg.com/esri-leaflet-geocoder@3.1.4/dist/esri-leaflet-geocoder.js"></script>
<link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.1.4/dist/esri-leaflet-geocoder.css">
{% endblock %}

{% block extra_styles %}
.form-section { margin-bottom: 2rem; padding: 1.5rem; background: #fff; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
.form-section-title { margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e9ecef; font-weight: bold; }
.form-section-description { margin-bottom: 1rem; color: #6c757d; }
.event-thumbnail { width: 200px; height: 120px; object-fit: cover; border-radius: 5px; display: block; margin-bottom: 10px; }
#map { height: 350px; width: 100%; border-radius: 8px; margin-bottom: 15px; position: relative; z-index: 1; display: block !important; }
.map-controls { display: flex; gap: 10px; margin-bottom: 15px; }
.location-preview { margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 5px; display: none; }
.location-preview.active { display: block; }
.resource-row { margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; }
.resource-select { flex: 1; margin-right: 15px; }
.quantity-input { width: 80px; }
.resource-actions { margin-left: 10px; }
.resource-list { margin-top: 1rem; }
.registration-themes-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; margin-bottom: 20px; padding: 10px; border-radius: 12px; background: rgba(0,0,0,0.02); }
.registration-theme-card { border-radius: 12px; overflow: hidden; box-shadow: 0 6px 12px rgba(0,0,0,0.12); transition: all 0.4s cubic-bezier(0.175,0.885,0.32,1.275); cursor: pointer; position: relative; height: 160px; border: 2px solid transparent; }
.registration-theme-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 20px rgba(0,0,0,0.2); }
.registration-theme-card.selected { border: 3px solid #3e64ff; transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 25px rgba(62,100,255,0.4); }
.registration-theme-card.selected::after { content: "\f00c"; font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background: #3e64ff; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(62,100,255,0.7); } 70% { box-shadow: 0 0 0 8px rgba(62,100,255,0); } 100% { box-shadow: 0 0 0 0 rgba(62,100,255,0); } }
.theme-name { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.75); color: #fff; padding: 10px 12px; font-size: 14px; font-weight: 500; text-transform: capitalize; backdrop-filter: blur(5px); transition: all 0.3s ease; }
.registration-theme-card:hover .theme-name { background: rgba(0,0,0,0.85); padding-bottom: 12px; color: #fff; }
.theme-minimalist { background: white; background-image: linear-gradient(to right, #f8f9fa, #fff); transition: all 0.3s ease; }
.theme-tech { background-color: #0c0e13; background-image: url('/static/theme_assets/tech/tech_background.gif'); background-size: cover; background-position: center; transition: all 0.3s ease; }
.theme-creative { background: linear-gradient(135deg,#6a11cb 0%,#2575fc 100%); background-image: url('/static/theme_assets/creative/creative_theme_background.gif'); background-size: cover; background-position: center; transition: all 0.3s ease; }
.theme-elegant { background: linear-gradient(to right,#000,#434343); transition: all 0.3s ease; }
.theme-retro { background-color: #f8e8c9; background-image: url('/static/theme_assets/retro/retro_background.jpg'); background-size: cover; background-position: center; transition: all 0.3s ease; }
{% endblock %}

{% block content %}
<div class="container py-4">
    <form id="createEventForm" method="POST" action="/api/events/create" enctype="multipart/form-data">
        <!-- Basic Information Section -->
        <div class="form-section">
            <h3 class="form-section-title">Basic Information</h3>
            <p class="form-section-description">Enter the basic details of your event that participants will see first.</p>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="eventName" class="form-label">Event Name*</label>
                    <input type="text" class="form-control" id="eventName" name="name" required>
                </div>
                <!-- Removed Display Title field: Only Event Name is used -->
                <div class="col-md-6">
                    <label for="eventCategory" class="form-label">Category*</label>
                    <select class="form-select" id="eventCategory" name="category" required>
                        <option value="" selected disabled>Select category</option>
                        <option value="academic">Academic</option>
                        <option value="cultural">Cultural</option>
                        <option value="sports">Sports</option>
                        <option value="technical">Technical</option>
                        <option value="workshop">Workshop</option>
                        <option value="seminar">Seminar</option>
                        <option value="competition">Competition</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="eventTags" class="form-label">Tags</label>
                    <input type="text" class="form-control" id="eventTags" name="tags" placeholder="Comma-separated tags (e.g. coding, fun, outdoor)">
                </div>
                <div class="col-12">
                    <label for="eventDescription" class="form-label">Description*</label>
                    <textarea class="form-control" id="eventDescription" name="description" rows="4" required></textarea>
                </div>
            </div>
        </div>
        <!-- Date and Time Section -->
        <div class="form-section">
            <h3 class="form-section-title">Date and Time</h3>
            <p class="form-section-description">Specify when your event will take place.</p>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date*</label>
                    <input type="date" class="form-control" id="startDate" name="start_date" required>
                </div>
                <div class="col-md-3">
                    <label for="startTime" class="form-label">Start Time*</label>
                    <input type="time" class="form-control" id="startTime" name="start_time" required>
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date*</label>
                    <input type="date" class="form-control" id="endDate" name="end_date" required>
                </div>
                <div class="col-md-3">
                    <label for="endTime" class="form-label">End Time*</label>
                    <input type="time" class="form-control" id="endTime" name="end_time" required>
                </div>
                <!-- Removed registration_end_date input field -->
            </div>
        </div>
        <!-- Venue and Location Section -->
        <div class="form-section">
            <h3 class="form-section-title">Venue and Location</h3>
            <p class="form-section-description">Provide details about where your event will take place.</p>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="venueName" class="form-label">Venue Name*</label>
                    <input type="text" class="form-control" id="venueName" name="venue" required placeholder="e.g. Main Auditorium">
                </div>
                <div class="col-md-6">
                    <label for="venueAddress" class="form-label">Address*</label>
                    <textarea class="form-control" id="venueAddress" name="venue_address" rows="2" placeholder="Enter the complete address of the venue" required></textarea>
                </div>
                <div class="col-12">
                    <label class="form-label">Map Location*</label>
                    <div class="map-controls align-items-center mb-2">
                        <div class="flex-grow-1">
                            <input type="text" class="form-control" id="locationSearch" placeholder="Search for a location...">
                        </div>
                        <button type="button" class="btn btn-outline-primary" id="searchLocationBtn"><i class="fas fa-search"></i> Search</button>
                        <button type="button" class="btn btn-outline-primary" id="useCurrentLocation"><i class="fas fa-map-marker-alt"></i> Use My Location</button>
                    </div>
                    <div id="map" class="mb-2"></div>
                    <div class="location-preview" id="locationPreview">
                        <div><strong>Selected Location:</strong> <span id="selectedLocationText"></span></div>
                        <div><strong>Coordinates:</strong> <span id="selectedCoordinates"></span></div>
                    </div>
                    <input type="hidden" id="locationLat" name="location_lat" required>
                    <input type="hidden" id="locationLng" name="location_lng" required>
                </div>
            </div>
        </div>
        <!-- Pricing and Registration Section -->
        <div class="form-section">
            <h3 class="form-section-title">Pricing and Registration</h3>
            <p class="form-section-description">Set up the pricing and registration options for your event.</p>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="isFreeCheck" name="is_free">
                        <label class="form-check-label" for="isFreeCheck">This is a free event</label>
                    </div>
                </div>
                <div class="col-md-4" id="priceContainer">
                    <label for="eventPrice" class="form-label">Price (â‚¹)*</label>
                    <input type="number" class="form-control" id="eventPrice" name="price" min="0" step="0.01" value="0">
                </div>
                <div class="col-md-4">
                    <label for="seatsTotal" class="form-label">Total Seats</label>
                    <input type="number" class="form-control" id="seatsTotal" name="seats_total" min="1" value="50">
                </div>
            </div>
            <div class="mb-4 mt-4">
                <label class="form-label">Registration Theme</label>
                <p class="text-muted mb-3">Choose a visually appealing theme for your event registration page</p>
                <input type="hidden" id="registrationThemeInput" name="registration_theme" value="minimalist">
                <div class="registration-themes-container">
                    <div class="registration-theme-card theme-minimalist" data-theme="minimalist">
                        <button type="button" class="theme-preview-btn"><i class="fas fa-eye"></i></button>
                        <div class="theme-name">Minimalist</div>
                    </div>
                    <div class="registration-theme-card theme-tech" data-theme="tech">
                        <button type="button" class="theme-preview-btn"><i class="fas fa-eye"></i></button>
                        <div class="theme-name">Tech</div>
                    </div>
                    <div class="registration-theme-card theme-creative" data-theme="creative">
                        <button type="button" class="theme-preview-btn"><i class="fas fa-eye"></i></button>
                        <div class="theme-name">Creative</div>
                    </div>
                    <div class="registration-theme-card theme-elegant" data-theme="elegant">
                        <button type="button" class="theme-preview-btn"><i class="fas fa-eye"></i></button>
                        <div class="theme-name">Elegant</div>
                    </div>
                    <div class="registration-theme-card theme-retro" data-theme="retro">
                        <button type="button" class="theme-preview-btn"><i class="fas fa-eye"></i></button>
                        <div class="theme-name">Retro</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Media and Files Section -->
        <div class="form-section">
            <h3 class="form-section-title">Media and Files</h3>
            <p class="form-section-description">Upload images, videos, and documents related to your event.</p>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="eventImage" class="form-label">Event Image</label>
                    <input type="file" class="form-control" id="eventImage" name="image" accept="image/*">
                    <div class="mt-2" id="imagePreview"></div>
                </div>
                <div class="col-md-6">
                    <label for="eventVideo" class="form-label">Video</label>
                    <input type="file" class="form-control" id="eventVideo" name="video" accept="video/*">
                    <small class="text-muted">Max size: 100MB</small>
                </div>
                <div class="col-md-6">
                    <label for="eventBrochure" class="form-label">Brochure/PDF</label>
                    <input type="file" class="form-control" id="eventBrochure" name="brochure" accept=".pdf">
                </div>
            </div>
        </div>
        <!-- Resources Required Section -->
        <div class="form-section">
            <h3 class="form-section-title">Resources Required (Optional)</h3>
            <p class="form-section-description">Specify the resources you need for this event.</p>
            <div class="resource-list" id="resourcesContainer">
                <div class="resource-row">
                    <div class="resource-select">
                        <select class="form-select resource-type-select" name="resource_type[]">
                            <option value="" disabled selected>Loading resources...</option>
                        </select>
                        <!-- Custom resource name input, shown only if 'Other' is selected -->
                        <input type="text" class="form-control mt-2 resource-other-input" name="resource_other[]" placeholder="Specify other resource" style="display:none;">
                    </div>
                    <div class="quantity-input">
                        <input type="number" class="form-control" name="resource_quantity[]" min="1" value="1">
                    </div>
                    <div class="resource-actions">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-resource"><i class="fas fa-trash"></i> Remove</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-outline-secondary mt-2" id="addResourceBtn"><i class="fas fa-plus"></i> Add Another Resource</button>
        </div>
        <!-- Notification Settings -->
        <div class="form-section">
            <h3 class="form-section-title">Notification Settings</h3>
            <p class="form-section-description">Configure who should be notified about this new event.</p>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="notifyParticipants" name="notify_participants" checked>
                <label class="form-check-label" for="notifyParticipants">Notify all participants about this new event</label>
                <div class="form-text text-muted">When checked, all registered participants will receive an email notification and an in-app notification about this event.</div>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="highlightImportant" name="highlight_important">
                <label class="form-check-label" for="highlightImportant">Mark as important notification</label>
                <div class="form-text text-muted">When checked, the notification will be marked as important, helping it stand out to participants.</div>
            </div>
            <div class="mb-3">
                <label for="customNotificationMsg" class="form-label">Custom Notification Message (optional)</label>
                <textarea class="form-control" id="customNotificationMsg" name="custom_notification_message" rows="3" placeholder="Enter a custom message to include with the notification"></textarea>
                <div class="form-text text-muted">Leave blank to use the default notification message.</div>
            </div>
        </div>
        <!-- Submit Section -->
        <div class="form-section text-center">
            <button type="submit" class="btn btn-primary btn-lg px-5">Create Event</button>
            <button type="button" class="btn btn-outline-secondary btn-lg px-5 ms-2" id="saveAsDraftBtn">Save as Draft</button>
        </div>
        <input type="hidden" name="is_draft" id="isDraft" value="0">
    </form>
</div>
<!-- Theme Preview Modal -->
<div class="modal fade" id="themePreviewModal" tabindex="-1" aria-labelledby="themePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="themePreviewModalLabel">Registration Theme Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="themePreviewFrame" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="useThemeBtn">Use This Theme</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// --- Utility: Preview image with error handling ---
function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    preview.innerHTML = '';
    try {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'event-thumbnail';
                preview.appendChild(img);
            };
            reader.readAsDataURL(input.files[0]);
        }
    } catch (error) {
        console.error("Error previewing image:", error);
    }
}

// --- Registration Theme Preview (global for HTML onclick) ---
let currentPreviewTheme = 'minimalist';
function previewRegistrationTheme(theme) {
    currentPreviewTheme = theme;
    const eventName = document.getElementById('eventName').value || 'Sample Event';
    const eventDescription = document.getElementById('eventDescription').value || 'This is a sample event description for preview purposes.';
    const previewFrame = document.getElementById('themePreviewFrame');
    const previewUrl = `/preview_registration_theme/${theme}?event_name=${encodeURIComponent(eventName)}&event_description=${encodeURIComponent(eventDescription)}&is_preview=true`;
    document.getElementById('themePreviewModalLabel').textContent = `${theme.charAt(0).toUpperCase() + theme.slice(1)} Theme Preview`;
    const modal = new bootstrap.Modal(document.getElementById('themePreviewModal'));
    modal.show();
    previewFrame.onload = function() {
        try {
            if (previewFrame.contentWindow.document.body) {
                previewFrame.contentWindow.document.body.classList.add(`theme-${theme}`);
            }
        } catch(e) {
            console.error("Error updating theme preview:", e);
        }
    };
    previewFrame.src = previewUrl;
}

let organiserResources = [];
let selectedResourceIds = new Set();
// Fetch organiser resources and populate dropdowns
async function loadOrganiserResources() {
    try {
        const response = await fetch('/api/resources');
        if (!response.ok) throw new Error('Failed to fetch resources');
        organiserResources = await response.json();
        updateAllResourceDropdowns();
    } catch (error) {
        Swal.fire({ icon: 'error', title: 'Error', text: 'Could not load organiser resources.' });
        organiserResources = [];
        updateAllResourceDropdowns();
    }
}
function updateAllResourceDropdowns() {
    document.querySelectorAll('.resource-type-select').forEach(select => {
        updateResourceDropdown(select);
    });
}
function updateResourceDropdown(selectElem) {
    // Save current value if any
    const prevValue = selectElem.value;
    selectElem.innerHTML = '';
    if (organiserResources.length === 0) {
        selectElem.innerHTML = '<option value="" disabled selected>No resources found</option>';
    } else {
        selectElem.innerHTML = '<option value="" disabled selected>Select resource</option>';
        organiserResources.forEach(resource => {
            if (resource.available_quantity > 0) {
                const isSelected = selectedResourceIds.has(String(resource.id));
                selectElem.innerHTML += `<option value="${resource.id}" data-img="${resource.image ? '/static/' + resource.image : ''}" ${isSelected && prevValue !== String(resource.id) ? 'disabled' : ''}>${resource.name} (${resource.category || 'Other'}, Available: ${resource.available_quantity})${isSelected && prevValue !== String(resource.id) ? ' [Already added]' : ''}</option>`;
            }
        });
        selectElem.innerHTML += '<option value="other">Other</option>';
    }
    // Restore previous value if possible
    if (prevValue) selectElem.value = prevValue;
    // Add image preview below dropdown
    showResourceImagePreview(selectElem);
    selectElem.addEventListener('change', function() { handleResourceTypeChange(this); showResourceImagePreview(this); updateSelectedResources(); });
    // Set max for quantity input
    setResourceQuantityLimit(selectElem);
}
function updateSelectedResources() {
    selectedResourceIds = new Set();
    document.querySelectorAll('.resource-type-select').forEach(select => {
        if (select.value && select.value !== 'other') {
            selectedResourceIds.add(select.value);
        }
    });
    updateAllResourceDropdowns();
}
function setResourceQuantityLimit(selectElem) {
    const quantityInput = selectElem.closest('.resource-row').querySelector('input[name="resource_quantity[]"]');
    const selectedId = selectElem.value;
    if (!quantityInput) return;
    if (selectedId && selectedId !== 'other') {
        const resource = organiserResources.find(r => String(r.id) === String(selectedId));
        if (resource) {
            quantityInput.max = resource.available_quantity;
            if (parseInt(quantityInput.value) > resource.available_quantity) {
                quantityInput.value = resource.available_quantity;
                Swal.fire({ icon: 'warning', title: 'Limit Exceeded', text: `Select within the available limit (${resource.available_quantity}).` });
            }
        }
    } else {
        quantityInput.removeAttribute('max');
    }
}
function showResourceImagePreview(selectElem) {
    let preview = selectElem.parentElement.querySelector('.resource-image-preview');
    if (!preview) {
        preview = document.createElement('div');
        preview.className = 'resource-image-preview mt-2';
        selectElem.parentElement.appendChild(preview);
    }
    const selectedOption = selectElem.options[selectElem.selectedIndex];
    const imgSrc = selectedOption && selectedOption.getAttribute('data-img');
    if (imgSrc) {
        preview.innerHTML = `<img src="${imgSrc}" alt="Resource Image" class="img-thumbnail" style="max-width: 100px; max-height: 70px;">`;
    } else {
        preview.innerHTML = '';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Map initialization
    let map, marker;
    const defaultLatLng = [13.0827, 80.2707]; // Chennai default
    function initializeMap() {
        const mapContainer = document.getElementById('map');
        if (!mapContainer) return;
        map = L.map('map').setView(defaultLatLng, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        marker = L.marker(defaultLatLng, { draggable: true }).addTo(map);
        marker.on('dragend', function() { updateSelectedLocation(marker.getLatLng()); });
        map.on('click', function(e) { marker.setLatLng(e.latlng); updateSelectedLocation(e.latlng); });
        document.getElementById('searchLocationBtn').addEventListener('click', function() {
            const searchQuery = document.getElementById('locationSearch').value;
            if (searchQuery.trim().length > 0) searchLocation(searchQuery);
        });
        document.getElementById('locationSearch').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); const searchQuery = document.getElementById('locationSearch').value; if (searchQuery.trim().length > 0) searchLocation(searchQuery); }
        });
        document.getElementById('useCurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                        marker.setLatLng(latlng);
                        map.setView(latlng, 15);
                        updateSelectedLocation(latlng);
                        reverseGeocode(latlng);
                    },
                    function(error) {
                        alert("Unable to get your current location. Please check your browser permissions.");
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });
    }
    function updateSelectedLocation(latLng) {
        document.getElementById('locationLat').value = latLng.lat.toFixed(6);
        document.getElementById('locationLng').value = latLng.lng.toFixed(6);
        document.getElementById('selectedCoordinates').textContent = `${latLng.lat.toFixed(6)}, ${latLng.lng.toFixed(6)}`;
        document.getElementById('locationPreview').classList.add('active');
        reverseGeocode(latLng);
    }
    function reverseGeocode(latLng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latLng.lat}&lon=${latLng.lng}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    document.getElementById('selectedLocationText').textContent = data.display_name;
                    const venueAddressField = document.getElementById('venueAddress');
                    if (venueAddressField.value.trim() === '') venueAddressField.value = data.display_name;
                }
            })
            .catch(error => { console.error("Error in reverse geocoding:", error); });
    }
    function searchLocation(query) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const location = data[0];
                    const latlng = L.latLng(location.lat, location.lon);
                    map.setView(latlng, 15);
                    marker.setLatLng(latlng);
                    updateSelectedLocation(latlng);
                } else {
                    alert("Location not found. Please try a different search term.");
                }
            })
            .catch(error => { alert("Error searching for location. Please try again."); });
    }
    setTimeout(initializeMap, 300);
    // Price toggle
    const isFreeCheck = document.getElementById('isFreeCheck');
    const priceInput = document.getElementById('eventPrice');
    const priceContainer = document.getElementById('priceContainer');
    isFreeCheck.addEventListener('change', function() {
        priceContainer.style.display = this.checked ? 'none' : 'block';
        if (this.checked) priceInput.value = '0';
    });
    // Image preview
    document.getElementById('eventImage').addEventListener('change', function(e) {
        previewImage(e.target, 'imagePreview');
    });
    // Add resource row
    document.getElementById('addResourceBtn').addEventListener('click', addResourceRow);
    function handleResourceTypeChange(selectElem) {
        // Show/hide the custom input for 'Other' option
        const otherInput = selectElem.closest('.resource-select').querySelector('.resource-other-input');
        if (selectElem.value === 'other') {
            otherInput.style.display = 'block';
            otherInput.required = true;
        } else {
            otherInput.style.display = 'none';
            otherInput.required = false;
        }
    }
    function addResourceRow() {
        try {
            const container = document.getElementById('resourcesContainer');
            const newRow = document.createElement('div');
            newRow.className = 'resource-row';
            newRow.innerHTML = `<div class="resource-select"><select class="form-select resource-type-select" name="resource_type[]"></select><input type="text" class="form-control mt-2 resource-other-input" name="resource_other[]" placeholder="Specify other resource" style="display:none;"></div><div class="quantity-input"><input type="number" class="form-control" name="resource_quantity[]" min="1" value="1"></div><div class="resource-actions"><button type="button" class="btn btn-sm btn-outline-danger remove-resource"><i class="fas fa-trash"></i> Remove</button></div>`;
            container.appendChild(newRow);
            // Populate dropdown with organiser resources
            updateResourceDropdown(newRow.querySelector('.resource-type-select'));
            // Add event listeners for new row
            newRow.querySelector('.remove-resource').addEventListener('click', function() {
                try {
                    container.removeChild(newRow);
                    updateSelectedResources();
                } catch (err) {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Could not remove resource row.' });
                }
            });
            newRow.querySelector('.resource-type-select').addEventListener('change', function() {
                handleResourceTypeChange(this);
                showResourceImagePreview(this);
                updateSelectedResources();
            });
            newRow.querySelector('input[name="resource_quantity[]"]').addEventListener('input', function() {
                const selectElem = newRow.querySelector('.resource-type-select');
                setResourceQuantityLimit(selectElem);
            });
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to add resource row.' });
        }
    }
    // Add event listener for initial resource type select
    document.querySelectorAll('.resource-type-select').forEach(function(selectElem) {
        selectElem.addEventListener('change', function() {
            handleResourceTypeChange(this);
            showResourceImagePreview(this);
            updateSelectedResources();
        });
    });
    document.querySelectorAll('input[name="resource_quantity[]"]').forEach(function(inputElem) {
        inputElem.addEventListener('input', function() {
            const selectElem = inputElem.closest('.resource-row').querySelector('.resource-type-select');
            setResourceQuantityLimit(selectElem);
        });
    });
    // Save as draft
    document.getElementById('saveAsDraftBtn').addEventListener('click', function() {
        document.getElementById('isDraft').value = '1';
        document.getElementById('createEventForm').submit();
    });
    // Form submission
    document.getElementById('createEventForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitForm();
    });
    // Theme selection
    const themeCards = document.querySelectorAll('.registration-theme-card');
    const themeInput = document.getElementById('registrationThemeInput');
    themeCards.forEach(card => {
        card.addEventListener('click', function() {
            themeCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            themeInput.value = this.getAttribute('data-theme');
        });
        card.querySelector('.theme-preview-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            previewRegistrationTheme(card.getAttribute('data-theme'));
        });
    });
    // Use theme from modal
    document.getElementById('useThemeBtn').addEventListener('click', function() {
        themeCards.forEach(card => {
            card.classList.remove('selected');
            if (card.getAttribute('data-theme') === currentPreviewTheme) card.classList.add('selected');
        });
        themeInput.value = currentPreviewTheme;
        const modal = bootstrap.Modal.getInstance(document.getElementById('themePreviewModal'));
        modal.hide();
    });
    loadOrganiserResources();
});
// --- Form submission logic ---
function submitForm() {
    const form = document.getElementById('createEventForm');
    const formData = new FormData(form);
    if (!formData.get('location_lat') || !formData.get('location_lng')) {
        alert("Please select a location on the map.");
        return false;
    }
    fetch(form.action, { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({ title: 'Success!', text: data.message || 'Event created successfully', icon: 'success', confirmButtonText: 'OK' }).then(() => { window.location.href = data.redirect; });
            } else {
                Swal.fire({ title: 'Error', text: data.error || 'Failed to create event', icon: 'error', confirmButtonText: 'OK' });
            }
        })
        .catch(error => {
            Swal.fire({ title: 'Error', text: 'An unexpected error occurred. Please try again.', icon: 'error', confirmButtonText: 'OK' });
        });
    return false;
}
</script>
{% endblock %}